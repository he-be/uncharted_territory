# 戦闘システム設計変更書：ドローン艦隊戦への移行

## 1. 現状分析 (Current State Analysis)

### 1.1 現在の実装 (`combatSystem.ts`)

現在の戦闘システムは、フィールド上のエンティティ同士が近接した際に発生する、シンプルな自動戦闘ロジックに基づいています。

- **基本メカニクス:**
  - **索敵:** `TARGET_SEARCH_INTERVAL`（3秒）ごとに周囲の敵対勢力をスキャン。
  - **エンゲージ:** 射程内（`COMBAT_RANGE`）に入ると、`combatEncounter` オブジェクトを生成し、双方を `COMBAT` ステートにロックします。
  - **ダメージ処理:** `FIRE_COOLDOWN`（1秒）ごとに互いのシールド・HPを削減します。
  - **可視化:** 戦闘領域を示す「エンカウンターゾーン（円）」と、参加者を結ぶ線を描画します。

- **勢力関係:**
  - **Pirate:** Trader（略奪目的）および Bounty Hunter（敵対）を攻撃。
  - **Bounty Hunter:** Pirate のみを攻撃。既存の戦闘に割り込む（Join）挙動を持つ。
  - **Trader:** 受動的。攻撃された場合のみ応戦（現在は逃走AI未実装で反撃のみ）。

### 1.2 直近の修正と安定化措置

以下の不具合修正を経て、現在のシステムは安定稼働しています。これらの修正ロジックは新システム移行時にも考慮（あるいは再利用）する必要があります。

1.  **Combat State Freeze (ゾンビ化バグ) の修正:**
    - _現象:_ 3者間戦闘（例: PirateがTraderを攻撃中にHunterに倒される）において、攻撃者死亡時に「被害者（Trader）」のCombatロックが解除されず、永遠に棒立ちになる。
    - _修正:_ 死亡時処理において、自身がターゲットしていた相手（Victim）の状態を強制的にクリアするロジックを追加。

2.  **Dangling Zones (残留ゾーン) の修正:**
    - _現象:_ 複数の戦闘に関与しているエンティティが死亡した際、メイン以外の戦闘ゾーンが消えずに残る。
    - _修正:_ 死亡エンティティが `Owner` となっている全てのエンカウンターゾーンを検索して破棄するクリーンアップ処理を実装。

3.  **NPC Overpopulation (過密) の抑制:**
    - _修正:_ バウンティハンターの総数を「全セクター数 × 3（現状39隻）」に制限し、パフォーマンスとゲームバランスを適正化。

### 1.3 現状の課題

- **戦術性の欠如:** 単純なステータスの削り合いであり、プレイヤーが介入する余地が（移動以外に）少ない。
- **スケール感の不足:** 1対1のドッグファイトが基本であり、「艦隊戦」や「戦争」の規模感を表現しにくい。
- **FTLモードの断念:** 当初予定していた「FTLライクなミニゲームへの画面遷移」は、シームレスなオープンワールド体験を阻害する可能性が高いため、方針を転換する。

---

## 2. 新デザイン：ドローン艦隊戦 (Drone Warfare)

Mount & Blade の部隊指揮システムを宇宙ドローン戦に翻案し、**「質と数」のマネジメント**を主軸とした戦闘システムへ移行します。

### 2.1 コアコンセプト

- **母艦としての船:**
  - 全ての船（Player/NPC）は「ドローン母艦」として機能する。
  - 本体の武装（レーザー等）はあくまで自衛・支援用であり、主戦力は搭載された**自律機動ドローン**である。
- **ドローン戦力 (+N):**
  - 船の直上に「+5」「+120」といったラベルでドローン残機数を表示。
  - 戦闘はドローン同士の消耗戦として表現される。

### 2.2 ドローン管理システム (Economy of War)

| Tier   | 名称          | 特徴                       | コスト/維持費   |
| :----- | :------------ | :------------------------- | :-------------- |
| **T1** | Scraper       | 低コスト・大量配備・紙装甲 | 低              |
| **T2** | Fighter       | バランス型                 | 中              |
| **T3** | Interceptor   | 対ドローン特化・高速       | 中高            |
| **T4** | Frigate-Drone | 高耐久・重武装             | 高              |
| **T5** | Elite         | 高AI・特殊兵装             | 激高 (希少資源) |

- **積載上限:** 母艦のサイズやPerk、NPCの場合は資金力（Wealth）によってキャップが決まる。
- **補充:** ステーションで購入、または戦闘後のデブリから「改修（Salvage）」して確率で獲得・レベルアップする。
- **維持:** 所持しているドローン数に応じて、定期的に費用が発生する（エネルギーの模擬）。費用が払えないと解体されてしまう。高Tierほど維持コストが高く、**「少数精鋭 vs 大群」**の経済的トレードオフを生む。

### 2.3 戦闘フロー

#### Phase 1: エンゲージ (Symbol Encounter)

敵対勢力（Pirate等）と接触した際、即座に戦闘が始まるのではなく、状況に応じた選択肢（UI）が表示される（設定で省略可）。

1.  **自動解決 (Auto-Resolve):**
    - _処理:_ 双方の「ドローン戦力値（数 × Tier係数）」に基づき、時間を進めて結果のみを算出する。
    - _演出:_ マップ上で戦闘バー（優勢/劣勢）が推移し、徐々に機数が減っていく。
    - _用途:_ 圧倒的格下との戦闘や、急いでいる時。

2.  **手動戦闘 (Manual Command):**
    - _処理:_ 2Dトップビュー（現状のマップ操作の延長）で、実際にドローンを展開して戦う。
    - _操作:_
      - 母艦の移動（矢印キー）、ズーム（Z／X）
      - ターゲット指定（クリック）
      - ドローン展開/帰還指示
      - 母艦武装の発射
    - _用途:_ 接戦、重要な戦闘、損害を抑えたい時。

3.  **撤退 (Retreat):**
    - _処理:_ 戦闘を回避して距離を取る。
    - _代償:_ 殿（しんがり）を務めたドローンの一部（例: 20%）が破壊・遺棄される。

#### Phase 2: 戦闘解決 (Resolution)

- **勝利:** 敵母艦の撃沈、または敵の撤退。
  - _報酬:_ クレジット（Bounty）、敵積載貨物、サルベージパーツ（ドローン補充用）。
  - _成長:_ 生き残ったドローンは経験値を積むか、サルベージパーツでTierアップのチャンス。
- **敗北:** 自艦の撃沈（ゲームオーバー/リスポーン）。

### 2.4 NPC経済と軍拡ロジック (NPC Economy & Expansion)

NPC（交易船・海賊船）は、経済活動で得た利益（Wealth）を軍事力に投資する自律的なロジックを持つ。

- **資金の用途優先順位:**
  1.  **維持費 (Maintenance):** 既存ドローンの維持エネルギー費。支払えない場合はドローンを「解体（売却）」して資金化する。
  2.  **補充 (Replenishment):** 定数（現在のキャパシティ）までドローンを補充する。
  3.  **拡張 (Expansion):** 資金に余裕がある場合、ドローン搭載上限（Capacity）を拡張する。
- **富の循環:**
  - **Trader:** 交易成功 → 資金増加 → 防衛力（ドローン）強化 → 生存率向上。
  - **Pirate:** 略奪成功 → 資金増加 → 攻撃力（ドローン）強化 → より危険な獲物を狙える。
  - **Sink (回収):** 戦闘によるドローン損耗と日々の維持費が、系全体のインフレを抑制するシンクとして機能する。

---

## 3. 実装・移行計画 (Implementation Plan)

### Step 1: 独立シミュレータによる検証 (Standalone Simulation)

ゲーム本体に統合する前に、以下の2つの独立したCLI/Webシミュレータを作成し、数理的な成立性を検証する。

1.  **経済・軍拡シミュレータ (Economy & Warfare Sim):**
    - _目的:_ 交易/略奪による収支と、ドローン維持費・購入費のバランス調整。
    - _検証:_ 長時間稼働させてもNPCが破産せず、かつ無限に強くなりすぎない（維持費で頭打ちになる）収束点を見つける。
2.  **戦闘バランスシミュレータ (Combat Balance Sim):**
    - _目的:_ 「数 vs 質」「自動解決の計算式」の調整。
    - _検証:_ T3ドローン10機がT1ドローン30機に勝てるか、等のバランス調整。

### Step 2: データ構造の拡張 (Data Structure)

既存の `CombatStatsComponent` を拡張し、ドローン情報を格納できるようにする。

```typescript
interface DroneHangar {
  tier: number;
  count: number;
  maxCount: number;
  // stats: { damage, hp, speed } ... (Tier定義参照)
}

// Entity Component拡張
interface CombatStats {
  hp: number;
  // ... existing ...
  drones: DroneHangar[]; // 複数Tier混成も視野に
}
```

### Step 2: 自動解決ロジックの実装 (Auto-Resolve Logic)

- `combatSystem.ts` に「シミュレーションモード」を追加。
- 物理的な弾発射を行わず、1秒ごとの計算で `drones.count` を減算させるロジックを作成。
- **UI:** 戦闘中のエンティティ上に「戦力ゲージ」を表示。

### Step 3: ドローン可視化 (Visualization)

- 母艦にラベル表示でテキストでドローンを表現。処理負荷を最小化する。

### Step 4: プレイヤー介入UI (Player Interaction)

- エンカウント時の「作戦ボード」UI（Auto/Manual/Retreat選択）。
- 手動戦闘時のドローン指揮コマンド（「攻撃開始」「護衛」「帰還」）。

---

## 4. 懸念点と対応

- **バランス調整:** マウント＆ブレイド同様、Tier間のバランス調整がシビアになる。
  - _対策:_ まずは、ゲームから独立した戦闘シミュレータを作成し、自動戦闘のバランスを検証する。次に、ゲームから独立した戦闘シミュレータを作成し、プレイヤー参加時の手動戦闘のメカニズムだけを作る。最後にゲーム本体に統合する。
