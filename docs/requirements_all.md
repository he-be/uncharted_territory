# A.L.V.A. プロジェクト要件定義書

## 1. プロジェクト概要

本プロジェクトは、30秒のレイテンシと80文字の生成制限を持つ特殊なTTS（Text-to-Speech）モデルを活用し、**「制約を逆手に取った、没入感あるAIコンパニオン体験」**を検証するための技術デモ兼ゲームアプリケーションです。

ゲームプレイは「Mount & Blade」や「Xシリーズ」にインスパイアされた宇宙貿易・戦闘シミュレーションをベースとしますが、主目的はあくまで**動的TTSを用いた会話型アプリケーションのUX実験**にあります。プレイヤーは宇宙船のパイロットとなり、AIパートナー「A.L.V.A.」と共に銀河を旅します。

---

## 2. ユーザーストーリー

プレイヤー（パイロット）、宇宙（システム）、そしてA.L.V.A.の3つの視点から、本システムが提供すべき体験を定義します。

### 2.1 パイロット（プレイヤー）の視点

**【探索と航行】**

- **US-1:** 私は、銀河全体の構造を把握するために、**グラフ構造のセクターマップ**を確認し、次に目指すべき貿易路や危険地帯を俯瞰したい。
- **US-2:** 私は、特定のセクターをクリックすることで、その宙域の詳細な**グローバル座標マップ**へスムーズにズームインし、自船を2D平面上で物理挙動（慣性あり）を伴って操作したい。
- **US-3:** 私は、広大な宇宙の「島」であるセクター間を移動するために、**ジャンプゲート**を利用して長距離移動を行いたい。

**【戦闘（ドローン艦隊戦）】**

- **US-4:** 私は、海賊や敵対勢力のシンボルに接触した際、自艦の搭載する**ドローン艦隊**を展開して戦闘を行いたい。ドローンの数や質（Tier）、そして母艦からの支援射撃を組み合わせて戦術的に勝利したい。
- **US-5:** 私は、戦闘開始時に敵戦力を評価し、**自動解決**で素早く結果を得るか、手動操作で**直接戦闘**に参加するか、あるいは被害を最小限に抑えて**撤退**するかを選択したい。

**【経済活動】**

- **US-6:** 私は、各セクターの需要と供給のギャップを利用し、安く仕入れて高く売る交易活動で利益を上げたい。
- **US-7:** 私は、ステーションの在庫が時間経過で**「自然消費」**され、常に需要が発生し続ける「生きた経済」の中で活動したい。

**【AIコンパニオン（A.L.V.A.）との対話】**

- **US-8:** 私は、長い航行中や作業中に、**A.L.V.A.**と雑談や世界観についての動的な会話を楽しみたい。
- **US-9:** 私は、30秒の通信ラグがあることを前提として、A.L.V.A.にスキャンや分析を依頼し、忘れた頃に届くレポートを受け取るという、宇宙ならではの非同期的な通信体験を楽しみたい。

### 2.2 生きた宇宙（自律NPCと経済システム）の視点

- **US-10:** システムは、プレイヤーの関与しない場所でも**NPC交易船**を自律的に航行させ、実際に物資をステーション間で輸送することで経済を流動させたい。
- **US-11:** システムは、海賊基地から**海賊船**をスポーンさせ、交易船を襲撃・破壊することで物資を市場から消滅（シンク）させ、インフレを抑制したい。
- **US-12:** システムは、巨大生物（スペースクラーケン）や戦争イベント等の脅威により、大量の物資需要（シンク）と供給停止を作り出し、経済バランスを動的に変化させたい。
- **US-13:** システムは、ステーション在庫の自然減少（消費）をシミュレートし、常に新規生産と物流が必要な状態を維持したい。

### 2.3 A.L.V.A.（システムインターフェース）の視点

- **US-14:** 私は、プレイヤーの入力に対して即座に**短文の承認応答（Acknowledgment Barks）**を返し、UIとしての即応性を担保したい。
- **US-15:** 私は、プレイヤーの現在の状況や行動履歴から次に来るであろう質問やイベントを予測し、バックグラウンドで**投機的にセリフを生成・キャッシュ**しておくことで、30秒のラグを感じさせないスムーズな応答を実現したい。

---

## 3. 機能要件

ブラウザ（ローカル）環境での動作を前提とした技術要件です。

### 3.1 マップ・移動システム

- **座標系:**
  - 全宇宙を単一の広大な2D浮動小数点座標系で管理。
  - 「セクター」は座標系上の特定エリアに密集するオブジェクト群として定義。
- **グラフビュー:**
  - セクターをノード、ゲート接続をエッジとする有向グラフ表示。
  - ノード選択によるカメラジャンプ機能。
- **移動物理:**
  - 慣性を考慮した2Dスラスター操作（Asteroidsライク）。
  - ゲート接触による座標転移処理。
  - 経路探索アルゴリズムによるオートパイロット補助。

### 3.2 経済・物流シミュレーション（ローカル動作）

- **エージェントベースシミュレーション:**
  - 数千〜数万単位のエンティティ（船、ステーション）の状態管理。
  - **LOD (Level of Detail)の排除:** プレイヤー近傍は完全シミュレーション、遠方は簡易計算（到着時間と取引結果のみ）を行いパフォーマンスを維持することも考えられるが、現時点では完全シミュレーションで作成する計画。
- **自然消費（Natural Consumption）システム:**
  - 各在庫品目ごとの消費関数実装（食料は早く、鉱石は遅く消費）。
  - Tickベースでの在庫更新処理。
- **生産シミュレーション:**
  - 各ステーションが一定時間ごとに一定量の物資を生産する。
  - 生産には材料が必要。なければ生産されない
  - 生産物は搬出されなければ、ステーション在庫として徐々に消費されていく

### 3.3 戦闘システム（ドローン艦隊戦）

- **基本コンセプト:**
  - 全ての船は「ドローン母艦」として機能する。
  - 戦闘は主にドローン同士のドッグファイトと、母艦による支援砲撃（レーザー等）で構成される。
  - 船のグラフィック上にドローン数が「+N」として表示され、カーソルオーバーで詳細（Tier内訳等）を確認可能。
- **ドローン管理:**
  - **積載限界:** プレイヤーはPerk投資、NPCは資金力に応じてドローン搭載上限が増加する。
  - **補充と強化:** 資金（クレジット）を消費してドローンを購入・補充する。戦闘後のサルベージ（改修）によるレベルアップ要素あり。
  - **階層システム (Tier):** 「数で押すか、質（Tier）で勝つか」の戦略性。高Tierドローンは高性能だが高コストおよび希少リソースを要求する。
- **戦闘モード:**
  - **シンボルエンカウント方式:** マップ上の敵シンボル接触時に戦闘開始。以下の選択肢を持つ。
  - **1. 自動解決:**
    - ドローン戦力値と時間経過によるシミュレーション。
    - 優勢/劣勢がバーで可視化され、戦闘の趨勢に応じて確率的に逃走や撃沈が発生する。
  - **2. 手動戦闘:**
    - グローバルマップと同様の移動方式を用いた2Dシューティング形式。
    - 母艦は主に指揮を行い、ドローンが自律的に戦闘を行う。母艦自身の武装による攻撃も可能。
  - **3. 撤退:**
    - 戦闘から離脱する。一定割合のドローンが破損・損失するペナルティが発生する。

### 3.4 A.L.V.A. 実装要件

- **アーキテクチャ:**
  - **パターン4：Acknowledgment Barks:** 入力直後の即時フィードバック用短文生成。
  - **パターン2：予測的バッチ生成:** ユーザー行動予測に基づく事前生成キャッシュ。
- **LLM統合:**
  - OpenRouter APIを利用した推論実行。
  - コンテキスト注入：現在のセクター、船体ステータス、直近のイベントログ。
- **レイテンシ隠蔽（ダイエジェティックUI）:**
  - 「通信解析中」「データ受信待機中」等のステータス表示による待機時間の演出。

---

## 4. 非機能要件・技術スタック

- **プラットフォーム:** Webブラウザ (PC推奨 / Local-first)
- **開発言語:** TypeScript
- **ゲームエンジン:** Phaser (2D描画・物理)
- **データ永続化:** LocalStorage / IndexedDB (ローカルセーブ)
- **アーキテクチャ:** ECS (Entity Component System) パターン
- **ビルド/テスト:** Vite, Vitest
- **品質管理:** husky pre-commit hook (typecheck, lintの強制)
- **パフォーマンス:**
  - 経済シミュレーション、経路探索等の重い処理は **Web Worker** オフロードを必須とする。
  - メインスレッド（描画）のブロッキングを回避。

---

## 5. 次のステップ

1.  **経済シミュレーションのプロトタイプ作成:**
    - 宇宙マップ生成、単純な交易AIの実装、消費サイクルの確認。
2.  経済シミュレーションのブラッシュアップ
    - 生産シミュレーションの実装
    - 物流の実装と確認
3.  敵の導入(このフェーズで4X要素を一通り完成させる)
    - 海賊船の生成と攻撃
    - クラーケンの生成と攻撃
    - 戦闘の実装と確認
    - 物流への影響
4.  UIのブラッシュアップ
    - メニューの実装と確認
5.  **A.L.V.A.接続テスト:**
    - 簡易チャットUIを通じたLLM/TTS連携の確認。
6.  **統合:**
    - ゲームイベント（到着、戦闘開始など）をトリガーとしたA.L.V.A.の発話実装。
